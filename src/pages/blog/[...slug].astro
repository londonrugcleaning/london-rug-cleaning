---
import { getCollection } from 'astro:content';

export const prerender = true;
import Layout from '../../layouts/Layout.astro';
import { TableOfContents } from '@/components/blog/TableOfContents';
import { CTAButtons } from '@/components/CTAButtons';
import { Calendar, User, Tag, ArrowLeft } from 'lucide-react';
import { ArticleSchema } from "@/components/seo/ArticleSchema";
import OptimizedImage from '@/components/OptimizedImage.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

function calculateReadingTime(content: string) {
  const wordsPerMinute = 200;
  const wordCount = content.split(/\s+/).length;
  const readingTime = Math.ceil(wordCount / wordsPerMinute);
  return `${readingTime} min read`;
}

const readingTime = calculateReadingTime(post.body);
---

<Layout 
  title={post.data.title} 
  description={post.data.excerpt}
  image={post.data.coverImage}
  article={{
    publishedTime: post.data.date,
    modifiedTime: post.data.date,
    authors: [post.data.author],
    tags: post.data.tags
  }}
>

  <ArticleSchema
    title={post.data.title}
    description={post.data.excerpt}
    url={`https://londonrugcleaning.co.uk/blog/${post.slug}`}
    imageUrl={post.data.coverImage || "https://londonrugcleaning.co.uk/og-image.png"}
    datePublished={post.data.date}
    dateModified={post.data.date}
    authorName={post.data.author}
    keywords={post.data.tags}
  />

  <div class="container mx-auto min-h-screen px-4 py-12">
    <div class="mx-auto max-w-3xl">
      <div class="mb-6">
        <a href="/blog" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 text-blue-800 hover:text-blue-900">
          <ArrowLeft className="mr-2 h-4 w-4" />
          Back to Blog
        </a>
      </div>

      <h1 class="text-3xl font-bold sm:text-4xl md:text-5xl">
        {post.data.title}
      </h1>

      {post.data.coverImage && (
        <div class="mt-8 mb-8 rounded-lg overflow-hidden">
          <OptimizedImage
            src={post.data.coverImage}
            alt={post.data.title}
            className="w-full h-auto object-cover max-h-[500px]"
            priority
          />
        </div>
      )}

      <div class="mt-4 flex flex-wrap items-center gap-4 text-muted-foreground">
        <div class="flex items-center gap-2">
          <Calendar className="h-4 w-4" />
          <span>{new Date(post.data.date).toLocaleDateString()}</span>
        </div>
        <div class="flex items-center gap-2">
          <User className="h-4 w-4" />
          <span>{post.data.author}</span>
        </div>
        <div class="flex items-center gap-2">
          <span>{readingTime}</span>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        {post.data.tags.map((tag) => (
          <div class="flex items-center gap-1 rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-800">
            <Tag className="h-3 w-3" />
            <span>{tag}</span>
          </div>
        ))}
      </div>

      <TableOfContents content={post.body} client:load />

      <div class="prose prose-blue mt-8 max-w-none blog-content">
        <Content />
      </div>

      <div class="mt-12 rounded-xl border border-border/60 bg-gradient-to-br from-blue-50 to-slate-50 dark:from-blue-950/30 dark:to-slate-900/50 p-8 text-center shadow-sm">
        <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200">Need Professional Rug Cleaning?</h3>
        <p class="mt-2 text-slate-600 dark:text-slate-400">
          Get a free quote for our expert rug cleaning services in London
        </p>
        <div class="mt-5 flex justify-center">
          <CTAButtons client:load />
        </div>
      </div>
    </div>
  </div>
</Layout>
